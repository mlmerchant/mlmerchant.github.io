<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><title>SMKC Mirror</title>
<style>body{font-family:sans-serif;padding:20px}input,button{margin:8px 0}#download{display:block;margin-top:12px}</style>
</head>
<body>
<h2>Super Mario Kart Track Mirror (.smkc)</h2>
<input type="file" id="f" accept=".smkc">
<button id="go" disabled>Mirror track</button>
<a id="download"></a>

<script>
const simple = /^#([A-Z0-9_]+)\s+([0-9A-F]+)$/;
const hexOnly = l => l.startsWith('#') && !simple.test(l) &&
                     /^[0-9A-F]+$/.test(l.slice(1).trim());

let original;

f.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = ev => { original = ev.target.result; go.disabled = false; download.style.display='none'; };
  r.readAsText(file);
};

go.onclick = () => {
  const lines = original.split(/\r?\n/);
  const out   = lines.slice();

  // locate #MAP … #OBJ (end of tile planes)
  const mapIdx = lines.findIndex(l => l.trim()==='#MAP');
  const objIdx = lines.findIndex((l,i)=> i>mapIdx && l.startsWith('#OBJ'));
  if (mapIdx<0||objIdx<0) return alert('MAP / OBJ not found');

  // width = bytes in first hex row / 2 (one byte per tile)
  const firstRow = lines.slice(mapIdx+1).find(hexOnly);
  const tileW    = firstRow.slice(1).trim().length/2;
  const pxW      = tileW*16;

  // collect simple fields to look up widths later
  const fields={};
  lines.forEach(l=>{const m=l.match(simple); if(m) fields[m[1]]=m[2];});

  // process MAP
  for(let i=mapIdx+1;i<objIdx;i++){
    const l = lines[i];
    if(hexOnly(l)){
      const bytes = l.slice(1).trim().match(/.{2}/g)
        .reverse()
        .map(h => (parseInt(h,16)^0x40).toString(16).toUpperCase().padStart(2,'0'));
      out[i] = '#'+bytes.join('');
    }
  }

  // mirror *_X simple fields
  out.forEach((l,idx)=>{
    const m = l.match(simple);
    if(m && m[1].endsWith('_X')){
      const key=m[1], old=parseInt(m[2],16);
      const wKey=key.slice(0,-1)+'W';
      const w   = fields[wKey]?parseInt(fields[wKey],16):0;
      const nx  = pxW - (old + w);
      out[idx]=`#${key} ${nx.toString(16).toUpperCase().padStart(m[2].length,'0')}`;
    }
  });

  const blob=new Blob([out.join('\n')],{type:'text/plain'});
  download.href=URL.createObjectURL(blob);
  download.download='mirrored.smkc';
  download.textContent='⤓ Download mirrored.smkc';
  download.style.display='inline-block';
};
</script>
</body>
</html>
